<html>
    <head>
        <title>WebSocket Remote Game Controller</title>
    </head>
    <body>
        <script type="text/javascript">
            var websocket = null;
            function initWebSocket() {
                try {
                    if (typeof MozWebSocket == 'function')
                        WebSocket = MozWebSocket;
                    var wsUri = window.location.protocol.replace('http', 'ws') + '//' + window.location.host
                    websocket = new WebSocket( wsUri );
                    websocket.onopen = function (evt) {
                        console.log("CONNECTED");
                    };
                    websocket.onclose = function (evt) {
                        console.log("DISCONNECTED");
                    };
                    websocket.onmessage = function (evt) {
                        console.log( "Message received :", evt.data );
                        console.log( evt.data );
                    };
                    websocket.onerror = function (evt) {
                        console.log('ERROR: ' + evt.data);
                    };
                } catch (exception) {
                    console.log('ERROR: ' + exception);
                }
            }
            initWebSocket()

            var lastMouse
            var lastTouch
            function handleMouseDown(e){
                e.preventDefault()
                if (websocket.readyState == 3)
                    initWebSocket()
                lastMouse = e
                websocket.send(JSON.stringify({type: 'start'}));
            }
            function handleMouseUp(e){
                websocket.send(JSON.stringify({type: 'end'}));
            }
            function handleMouseMove(e){
                if (e.which) {
                    websocket.send(JSON.stringify({type: 'move', x: e.clientX - lastMouse.clientX, y: e.clientY - lastMouse.clientY, t: e.timeStamp - lastMouse.timeStamp}));
                    lastMouse = e
                }
            }
            function handleTouchStart(e) {
                e.preventDefault()
                if (websocket.readyState == 3)
                    initWebSocket()

                if (!lastTouch) {
                    websocket.send(JSON.stringify({type: 'start'}));
                    lastTouch = e.changedTouches[0]
                    lastTouch.timeStamp = e.timeStamp
                }
            }
            function handleTouchMove(e) {
                if (!lastTouch)
                    return
                for (var i = 0; i < e.changedTouches.length; i++) {
                    var t = e.changedTouches[i]
                    if (t.identifier == lastTouch.identifier) {
                        websocket.send(JSON.stringify({type: 'move', x: t.pageX - lastTouch.pageX, y: t.pageY - lastTouch.pageY, t: e.timeStamp - lastTouch.timeStamp}));
                        lastTouch = t
                        lastTouch.timeStamp = e.timeStamp
                    }
                }
            }
            function handleTouchEnd(e) {
                if (!lastTouch)
                    return
                for (var i = 0; i < e.changedTouches.length; i++)
                    if (e.changedTouches[i].identifier == lastTouch.identifier) {
                        websocket.send(JSON.stringify({type: 'end'}));
                        lastTouch = null
                    }
            }
            document.documentElement.addEventListener('mousedown', handleMouseDown)
            document.documentElement.addEventListener('mouseup', handleMouseUp)
            document.documentElement.addEventListener('mousemove', handleMouseMove)
            document.documentElement.addEventListener("touchstart", handleTouchStart);
            document.documentElement.addEventListener("touchmove", handleTouchMove);
            document.documentElement.addEventListener("touchend", handleTouchEnd);
        </script>
    </body>
</html>
