<html>
    <head>
        <title>WebSocket Remote Game Controller</title>
    </head>
    <body>
        <script type="text/javascript">
            var websocket = null;
            function initWebSocket() {
                try {
                    if (typeof MozWebSocket == 'function')
                        WebSocket = MozWebSocket;
                    var wsUri = window.location.protocol.replace('http', 'ws') + '//' + window.location.host
                    websocket = new WebSocket( wsUri );
                    websocket.onopen = function (evt) {
                        console.log("CONNECTED");
                    };
                    websocket.onclose = function (evt) {
                        console.log("DISCONNECTED");
                    };
                    websocket.onmessage = function (evt) {
                        console.log( "Message received :", evt.data );
                        console.log( evt.data );
                    };
                    websocket.onerror = function (evt) {
                        console.log('ERROR: ' + evt.data);
                    };
                } catch (exception) {
                    console.log('ERROR: ' + exception);
                }
            }
            initWebSocket()

            var lastX, lastY, lastTime
            function handleMouseDown(e){
                e.preventDefault()
                if (websocket.readyState == 3)
                    initWebSocket()
                lastX = e.clientX
                lastY = e.clientY
                lastTime = e.timeStamp
                websocket.send(JSON.stringify({type: 'start'}));
            }
            function handleMouseUp(e){
                websocket.send(JSON.stringify({type: 'end'}));
            }
            function handleMouseMove(e){
                if (e.which) {
                    websocket.send(JSON.stringify({type: 'move', x: e.clientX - lastX, y: e.clientY - lastY, t: e.timeStamp - lastTime}));
                    lastX = e.clientX
                    lastY = e.clientY
                    lastTime = e.timeStamp
                }
            }
            function handleTouchStart(e) {
                e.preventDefault()
                if (websocket.readyState == 3)
                    initWebSocket()
                lastX = e.changedTouches[0].pageX
                lastY = e.changedTouches[0].pageY
                lastTime = e.timeStamp
                websocket.send(JSON.stringify({type: 'start'}));
            }
            function handleTouchMove(e) {
                var t = e.changedTouches[0]
                websocket.send(JSON.stringify({type: 'move', x: t.pageX - lastX, y: t.pageY - lastY, t: e.timeStamp - lastTime}));
                lastX = t.pageX
                lastY = t.pageY
                lastTime = e.timeStamp
            }
            function handleTouchEnd(e) {
                websocket.send(JSON.stringify({type: 'end'}));
            }
            document.body.addEventListener('mousedown', handleMouseDown)
            document.body.addEventListener('mouseup', handleMouseUp)
            document.body.addEventListener('mousemove', handleMouseMove)
            document.body.addEventListener("touchstart", handleTouchStart);
            document.body.addEventListener("touchmove", handleTouchMove);
            document.body.addEventListener("touchend", handleTouchEnd);
        </script>
    </body>
</html>
